#!/bin/sh
#
#  viab-publish - Vac-in-a-Box RPM and ISO publisher
#
#  Andrew McNab, University of Manchester.
#  Copyright (c) 2015. All rights reserved.
#
#  Redistribution and use in source and binary forms, with or
#  without modification, are permitted provided that the following
#  conditions are met:
#
#    o Redistributions of source code must retain the above
#      copyright notice, this list of conditions and the following
#      disclaimer. 
#    o Redistributions in binary form must reproduce the above
#      copyright notice, this list of conditions and the following
#      disclaimer in the documentation and/or other materials
#      provided with the distribution. 
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
#  CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
#  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
#  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
#  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
#  BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
#  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
#  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
#  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
#  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
#  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
#  POSSIBILITY OF SUCH DAMAGE.
#
#  Contacts: Andrew.McNab@cern.ch  http://www.gridpp.ac.uk/vac/
#

echo -n '#### Starting viab-publish ' ; date

source /var/lib/viab/VERSION
export VIAB_VERSION=$VERSION
export DOCUMENT_ROOT=/home/apache/websites/viab.gridpp.ac.uk

# Defaults for testing

if [ "$1" = "" ] ; then
 export VIAB_SITENAME=UKI-NORTHGRID-MAN-HEP
 export VIAB_SPACENAME=vac04.tier2.hep.manchester.ac.uk
 export VIAB_PASSWORD_HASH='sjsdkfjskdFJKSDJFKSAJDKFJ293JF2N3F23NI28394239FJ239FH2'

 TEMPDIR=`mktemp -d`
 cd $TEMPDIR
 mkdir -p viab-conf
 cp -a /var/lib/viab/db/$VIAB_SITENAME/$VIAB_SPACENAME/* viab-conf
 echo $VIAB_SITENAME > viab-conf/viab/sitename
 echo $VIAB_SPACENAME > viab-conf/viab/spacename
else
 TEMPDIR="$1"
 cd $TEMPDIR
 export VIAB_SITENAME=`cat viab-conf/viab/sitename`
 export VIAB_SPACENAME=`cat viab-conf/viab/spacename`
 export VIAB_PASSWORD_HASH='sjsdkfjskdFJKSDJFKSAJDKFJ293JF2N3F23NI28394239FJ239FH2'
fi

# Ensure web directories exist

mkdir -p $DOCUMENT_ROOT/SRPMS/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION \
         $DOCUMENT_ROOT/repo/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION  \
         $DOCUMENT_ROOT/ks/$VIAB_SITENAME/$VIAB_SPACENAME \
         $DOCUMENT_ROOT/iso/$VIAB_SITENAME/$VIAB_SPACENAME

# Update access control
echo -n '#### Make access control ' ; date

cat $TEMPDIR/viab-conf/viab/hosts-network | (

iplist=''

while read mac host ip
do
  iplist="$iplist $ip"
done

echo 'Order Deny,Allow'
echo 'Deny from all'
echo "Allow from$iplist"

) > $DOCUMENT_ROOT/repo/$VIAB_SITENAME/.htaccess

cp -f $DOCUMENT_ROOT/repo/$VIAB_SITENAME/.htaccess \
      $DOCUMENT_ROOT/ks/$VIAB_SITENAME/.htaccess

cp -f $DOCUMENT_ROOT/repo/$VIAB_SITENAME/.htaccess \
      $DOCUMENT_ROOT/SRPMS/$VIAB_SITENAME/.htaccess

# Make RPM in $TEMPDIR
echo -n '#### Make RPMs and repo ' ; date

mkdir -p SOURCES SPECS BUILD SRPMS RPMS/noarch BUILDROOT
cp -p /var/lib/viab/etc/viab-conf-postinstall \
      /var/lib/viab/etc/viab-conf-p12 \
      /var/lib/viab/etc/lazyssh \
      /var/lib/viab/etc/dnsmasq-wrapper \
      /var/lib/viab/etc/squid.conf.template \
      /var/lib/viab/etc/vac-ssmsend-cron \
      /var/lib/viab/etc/vac-ssmsend-prod.cfg \
      viab-conf
cp /var/lib/viab/isolinux/vmlinuz /var/lib/viab/isolinux/initrd.img viab-conf
tar zcvf SOURCES/viab-conf.tgz --owner=root --group=root --exclude-backups viab-conf
cp /var/lib/viab/etc/viab-conf.spec .
rpmbuild -ba --define "_topdir $TEMPDIR" --buildroot $TEMPDIR/BUILDROOT viab-conf.spec

cp SRPMS/viab-conf-*-1.src.rpm $DOCUMENT_ROOT/SRPMS/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION
find $DOCUMENT_ROOT/SRPMS/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION -name '*.rpm' -ctime +1 -exec rm -f {} \;

#rm -Rf $DOCUMENT_ROOT/repo/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION/*
cp RPMS/noarch/viab-conf-*-1.noarch.rpm $DOCUMENT_ROOT/repo/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION
find $DOCUMENT_ROOT/repo/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION -name '*.rpm' -ctime +1 -exec rm -f {} \;
createrepo $DOCUMENT_ROOT/repo/$VIAB_SITENAME/$VIAB_SPACENAME/$VIAB_VERSION

# Make proxy-less ks-usb.cfg for USB-based installation
echo -n '#### Make ks-*.cfg ' ; date

sed -e "s/##VIAB_SITENAME##/$VIAB_SITENAME/g"		\
    -e "s/##VIAB_SPACENAME##/$VIAB_SPACENAME/g"		\
    -e "s/##VIAB_VERSION##/$VIAB_VERSION/g"     	\
    -e "s/##VIAB_PASSWORD_HASH##/$VIAB_PASSWORD_HASH/g"	\
    /var/lib/viab/etc/ks.cfg       	  	\
    > $DOCUMENT_ROOT/ks/$VIAB_SITENAME/$VIAB_SPACENAME/ks-usb.cfg

cat $TEMPDIR/viab-conf/viab/hosts-network | (

while read mac host ip
do
  sed -e "s/##VIAB_SITENAME##/$VIAB_SITENAME/g"			\
      -e "s/##VIAB_SPACENAME##/$VIAB_SPACENAME/g"		\
      -e "s/##VIAB_VERSION##/$VIAB_VERSION/g"     		\
      -e "s/##VIAB_PASSWORD_HASH##/$VIAB_PASSWORD_HASH/g"	\
      -e "s/^url.*/& --proxy=http:\/\/$ip:3128\//"		\
      /var/lib/viab/etc/ks.cfg         				\
      > $DOCUMENT_ROOT/ks/$VIAB_SITENAME/$VIAB_SPACENAME/ks-$host.cfg
done

)

if [ "$1" = "" ] ; then
 # Only delete directories if we created them
 rm -Rf $TEMPDIR
fi

# Make viab-usb.iso for USB-based installation
echo -n '#### Make viab-usb.iso ' ; date

ISOTEMPDIR=`mktemp -d`

cp /var/lib/viab/isolinux/* \
   /var/lib/viab/etc/splash.jpg \
   /var/lib/viab/etc/isolinux.cfg $ISOTEMPDIR
sed -i "s/##VIAB_SITENAME##/$VIAB_SITENAME/g" $ISOTEMPDIR/isolinux.cfg
sed -i "s/##VIAB_SPACENAME##/$VIAB_SPACENAME/g" $ISOTEMPDIR/isolinux.cfg

/usr/bin/genisoimage \
 -o $DOCUMENT_ROOT/iso/$VIAB_SITENAME/$VIAB_SPACENAME/viab-usb.iso \
 -b isolinux.bin \
 -c boot.cat \
 -no-emul-boot \
 -boot-load-size 4 \
 -boot-info-table \
 -input-charset default \
 -V 'Vac-in-a-Box' \
 -volset 'Vac-in-a-Box' \
 -R -J -v -T $ISOTEMPDIR

/var/lib/viab/bin/isohybrid-SL66 $DOCUMENT_ROOT/iso/$VIAB_SITENAME/$VIAB_SPACENAME/viab-usb.iso

rm -Rf $ISOTEMPDIR/*
rmdir $ISOTEMPDIR

echo -n '#### End of viab-publish ' ; date

exit 0
